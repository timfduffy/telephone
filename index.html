<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Telephone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .description {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .model-selection {
            margin-bottom: 30px;
        }

        .model-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
        }

        .model-group {
            flex: 1;
        }

        .model-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            transition: border-color 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
        }

        .input-section {
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .game-area {
            margin-top: 30px;
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .step h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #3498db;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .step img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .prompt {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            font-style: italic;
            margin: 10px 0;
        }

        .status {
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }

        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin: 10px 0;
        }

        .success {
            color: #27ae60;
            background: #f2f8f5;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
            margin: 10px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .final-result {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 30px;
        }

        .final-result h2 {
            margin-bottom: 15px;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison div {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .comparison h4 {
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @media (max-width: 600px) {
            .model-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû AI Telephone ‚òéÔ∏è</h1>
        <p class="description">
            Enter a text prompt and watch a pair of models take turns 
            making the prompt into an image and trying to guess the image prompt.
        </p>

        <div class="model-selection">
            <div class="model-row">
                <div class="model-group">
                    <label for="imageModel">Image Generation Model:</label>
                    <select id="imageModel">
                        <option value="runware:108@1">Qwen-Image</option>
                        <option value="runware:97@3" selected>HiDream-i1Fast</option>
                        <option value="runware:100@1">FLUX.1 Schnell</option>
                    </select>
                </div>
                <div class="model-group">
                    <label for="textModel">Text Analysis Model:</label>
                    <select id="textModel">
                        <option value="google/gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="qwen/qwen3-vl-235b-a22b-instruct">Qwen3-VL</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="input-section">
            <label for="initialPrompt">Enter your starting prompt:</label>
            <input type="text" id="initialPrompt" placeholder="e.g., A cat wearing a space helmet floating in zero gravity">
        </div>

        <button id="startButton" onclick="startGame()">Start Telephone Game</button>

        <div id="gameArea" class="game-area"></div>
    </div>

    <script src="config.js"></script>
    <script>
        let gameInProgress = false;

        function createLoadingElement(message) {
            const div = document.createElement('div');
            div.className = 'status';
            div.innerHTML = `<span class="loading"></span>${message}`;
            return div;
        }

        function createSuccessElement(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            return div;
        }

        function createErrorElement(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = `Error: ${message}`;
            return div;
        }

        async function getRunwareApiKey() {
            let runwareKey = '';
            
            console.log('Getting Runware API key...');
            
            // Try local config first
            if (window.LOCAL_CONFIG && window.LOCAL_CONFIG.RUNWARE_API_KEY) {
                runwareKey = window.LOCAL_CONFIG.RUNWARE_API_KEY;
                console.log('Using Runware API key from local config, length:', runwareKey.length);
            }
            
            // If no key, try to get from server (environment variable)
            if (!runwareKey) {
                console.log('Attempting to fetch key from server...');
                try {
                    const response = await fetch('/api/runware-key');
                    console.log('Server response status:', response.status);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.apiKey) {
                            runwareKey = data.apiKey;
                            console.log('Using Runware API key from environment variable, length:', runwareKey.length);
                        }
                    }
                } catch (error) {
                    console.log('Could not fetch Runware key from server:', error.message);
                }
            }
            
            if (!runwareKey) {
                console.error('No Runware API key found');
                throw new Error('Runware API key is required. Please set it in config.js for local development or set RUNWARE_API_KEY environment variable for deployment.');
            }
            
            return runwareKey;
        }

        // Generate UUID v4
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function generateImage(prompt, retryCount = 0) {
            console.log('Generating image with prompt:', prompt);
            
            // Get selected model and configure parameters
            const selectedModel = document.getElementById('imageModel').value;
            const isFlux = selectedModel === 'runware:100@1';
            const isHiDream = selectedModel === 'runware:97@3';
            
            let steps = 20; // Default for Qwen-Image
            if (isFlux) {
                steps = 4;
            } else if (isHiDream) {
                steps = 16;
            }
            
            const imageParams = {
                taskType: "imageInference",
                taskUUID: generateUUID(),
                model: selectedModel,
                positivePrompt: prompt,
                height: isFlux ? 1024 : 512,
                width: isFlux ? 1024 : 512,
                numberResults: 1,
                outputType: ["URL"],
                outputFormat: "WEBP",
                CFGScale: 2.5,
                steps: steps,
                scheduler: "Default",
                includeCost: true,
                outputQuality: 85
            };
            
            console.log('Using model:', selectedModel, 'Parameters:', imageParams);
            
            // Try server-side function first (for deployment)
            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt, imageParams })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.imageUrl) {
                        console.log('Image generated via server-side function');
                        return data.imageUrl;
                    } else if (data.error) {
                        throw new Error(data.error);
                    }
                }
            } catch (serverError) {
                console.log('Server-side generation not available, falling back to client-side:', serverError.message);
            }

            // Fallback to direct API call (for local development)
            const apiKey = await getRunwareApiKey();

            try {
                const response = await fetch('https://api.runware.ai/v1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify([imageParams])
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    if (response.status === 500 && retryCount === 0) {
                        console.log('Retrying due to 500 error...');
                        return generateImage(prompt, 1);
                    }
                    throw new Error(`Runware API error: ${response.status} - ${errorData}`);
                }

                const data = await response.json();
                console.log('Runware API response:', data);
                
                if (data && data.data && Array.isArray(data.data) && data.data.length > 0) {
                    const result = data.data[0];
                    if (result.imageURL) {
                        return result.imageURL;
                    } else if (result.imageDataURI) {
                        return result.imageDataURI;
                    } else if (result.imageBase64Data) {
                        return `data:image/webp;base64,${result.imageBase64Data}`;
                    }
                    throw new Error('No image URL in response');
                } else {
                    throw new Error('Invalid response format from Runware API');
                }
            } catch (error) {
                console.error('Image generation error:', error);
                throw new Error(`Image generation failed: ${error.message}. Note: Runware may require their SDK for API access.`);
            }
        }

        async function analyzeImage(imageUrl) {
            // Get selected text model
            const selectedTextModel = document.getElementById('textModel').value;
            console.log('Using text model:', selectedTextModel);

            // Try to use server-side function first (for production deployment)
            try {
                const response = await fetch('/api/analyze-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        imageUrl,
                        textModel: selectedTextModel 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.analyzedPrompt) {
                        console.log('Image analyzed via server-side function');
                        return data.analyzedPrompt;
                    } else if (data.error) {
                        throw new Error(data.error);
                    }
                }
            } catch (serverError) {
                console.log('Server-side analysis not available, falling back to client-side:', serverError.message);
            }

            // Fallback to client-side API call (for local development)
            let openrouterKey = '';
            
            // Try local config first
            if (window.LOCAL_CONFIG && window.LOCAL_CONFIG.OPENROUTER_API_KEY) {
                openrouterKey = window.LOCAL_CONFIG.OPENROUTER_API_KEY;
                console.log('Using OpenRouter API key from local config');
            }
            
            if (!openrouterKey) {
                throw new Error('OpenRouter API key is required. Please set it in config.js for local development or set OPENROUTER_API_KEY environment variable for deployment.');
            }

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openrouterKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'AI Telephone'
                    },
                    body: JSON.stringify({
                        model: selectedTextModel,
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: "This image was created by an AI image generator. Give your best guess at the prompt used. Include no other text, your only output should be your guess about the prompt that generated the image."
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageUrl
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`OpenRouter API error: ${response.status} - ${errorData}`);
                }

                const data = await response.json();
                console.log('OpenRouter API response:', data);
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content.trim();
                } else {
                    throw new Error('Invalid response format from OpenRouter API');
                }
            } catch (error) {
                console.error('Image analysis error:', error);
                throw new Error(`Image analysis failed: ${error.message}`);
            }
        }

        async function startGame() {
            const initialPrompt = document.getElementById('initialPrompt').value.trim();
            
            if (!initialPrompt) {
                alert('Please enter a starting prompt!');
                return;
            }

            if (gameInProgress) {
                return;
            }

            gameInProgress = true;
            const startButton = document.getElementById('startButton');
            const gameArea = document.getElementById('gameArea');
            
            startButton.disabled = true;
            startButton.textContent = 'Game in Progress...';
            gameArea.innerHTML = '';

            let currentPrompt = initialPrompt;
            const results = [];

            try {
                for (let i = 1; i <= 4; i++) {
                    console.log(`Starting step ${i} with prompt:`, currentPrompt);
                    
                    // Create step container
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    stepDiv.innerHTML = `
                        <h3><span class="step-number">${i}</span>Step ${i}</h3>
                        <div class="prompt">
                            <strong>Prompt:</strong> "${currentPrompt}"
                        </div>
                    `;
                    gameArea.appendChild(stepDiv);

                    // Generate image
                    const imageLoadingDiv = createLoadingElement('Generating image...');
                    stepDiv.appendChild(imageLoadingDiv);

                    try {
                        const imageUrl = await generateImage(currentPrompt);
                        stepDiv.removeChild(imageLoadingDiv);
                        
                        const imageDiv = document.createElement('div');
                        imageDiv.innerHTML = `<img src="${imageUrl}" alt="Generated image for step ${i}">`;
                        stepDiv.appendChild(imageDiv);
                        
                        stepDiv.appendChild(createSuccessElement('Image generated successfully!'));

                        // Analyze image
                        const analysisLoadingDiv = createLoadingElement('Analyzing image...');
                        stepDiv.appendChild(analysisLoadingDiv);

                        const analyzedPrompt = await analyzeImage(imageUrl);
                        stepDiv.removeChild(analysisLoadingDiv);
                        
                        const analysisDiv = document.createElement('div');
                        analysisDiv.className = 'prompt';
                        analysisDiv.innerHTML = `<strong>AI Analysis:</strong> "${analyzedPrompt}"`;
                        stepDiv.appendChild(analysisDiv);
                        
                        stepDiv.appendChild(createSuccessElement('Analysis complete!'));

                        // Store results
                        results.push({
                            step: i,
                            inputPrompt: currentPrompt,
                            imageUrl: imageUrl,
                            analyzedPrompt: analyzedPrompt
                        });

                        // Set up for next iteration
                        currentPrompt = analyzedPrompt;

                    } catch (error) {
                        stepDiv.removeChild(imageLoadingDiv);
                        stepDiv.appendChild(createErrorElement(error.message));
                        throw error;
                    }
                }

                // Show final results
                const finalDiv = document.createElement('div');
                finalDiv.className = 'final-result';
                finalDiv.innerHTML = `
                    <h2>üéâ Game Complete!</h2>
                    <p>Here's how your prompt evolved through 4 rounds of AI telephone:</p>
                    <div class="comparison">
                        <div>
                            <h4>Original Prompt</h4>
                            <p>"${initialPrompt}"</p>
                        </div>
                        <div>
                            <h4>Final Result</h4>
                            <p>"${results[results.length - 1].analyzedPrompt}"</p>
                        </div>
                    </div>
                `;
                gameArea.appendChild(finalDiv);

            } catch (error) {
                console.error('Game error:', error);
                gameArea.appendChild(createErrorElement(`Failed to start game: ${error.message}`));
            } finally {
                gameInProgress = false;
                startButton.disabled = false;
                startButton.textContent = 'Start Telephone Game';
            }
        }

        // Initialize the game when page loads
        window.addEventListener('load', async function() {
            console.log('AI Telephone loaded.');
            console.log('API keys will be loaded from config.js (local) or environment variables (deployment)');
        });
    </script>
</body>
</html>